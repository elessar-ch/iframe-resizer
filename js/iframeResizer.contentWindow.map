{"version":3,"file":"iframeResizer.contentWindow.min.js","sources":["..\\src\\iframeResizer.contentWindow.js"],"names":["addEventListener","el","evt","func","window","attachEvent","formatLogMsg","msg","msgID","myID","log","logging","console","warn","init","readData","setMargin","setBodyStyle","bodyBackground","bodyPadding","injectClearFixIntoBodyElement","checkHeightMode","stopInfiniteResizingOfIFrame","setupPublicMethods","startEventListeners","inPageLinks","setupInPageLinks","sendSize","strBool","str","data","initMsg","substr","msgIdLen","split","bodyMargin","undefined","Number","calculateWidth","interval","publicMethods","autoResize","bodyMarginStr","heightCalcMode","tolerance","enable","resizeFrom","chkCSS","attr","value","indexOf","document","body","style","documentElement","height","addTriggerEvent","options","addListener","eventName","e","eventType","eventNames","Array","prototype","map","initEventListeners","heightCalcModeDefault","getHeight","setupMutationObserver","clearFix","createElement","clear","display","appendChild","getPagePosition","x","pageXOffset","scrollLeft","y","pageYOffset","scrollTop","getElementPosition","elPosition","getBoundingClientRect","pagePosition","parseInt","left","top","findTarget","location","jumpToTarget","target","jumpPosition","hash","sendMsg","hashData","decodeURIComponent","getElementById","getElementsByName","checkLocationHash","href","bindAnchors","setupLink","linkClicked","preventDefault","this","getAttribute","forEach","call","querySelectorAll","bindLocationHash","initCheck","setTimeout","eventCancelTimer","enableInPageLinks","parentIFrame","close","getId","moveToAnchor","reset","resetIFrame","scrollTo","scrollToOffset","sendMessage","targetOrigin","JSON","stringify","setHeightCalculationMethod","heightCalculationMethod","setTargetOrigin","targetOriginDefault","size","customHeight","customWidth","valString","lockTrigger","initInterval","setInterval","Math","abs","setupInjectElementLoadListners","mutations","addLoadListener","element","width","src","mutation","type","attributeName","images","image","createMutationObserver","querySelector","config","attributes","attributeOldValue","characterData","characterDataOldValue","childList","subtree","observer","MutationObserver","observe","WebKitMutationObserver","getBodyOffsetHeight","getComputedBodyStyle","prop","convertUnitsToPxForIE8","PIXEL","test","base","runtimeStyle","currentStyle","pixelLeft","retVal","defaultView","getComputedStyle","offsetHeight","getBodyScrollHeight","scrollHeight","getDEOffsetHeight","getDEScrollHeight","getLowestElementHeight","allElements","allElementsLength","length","maxBottomVal","timer","Date","getTime","i","bottom","getAllHeights","getMaxHeight","max","apply","getMinHeight","min","getBestHeight","getWidth","scrollWidth","triggerEvent","triggerEventDesc","recordTrigger","resetPage","resizeIFrame","currentHeight","currentWidth","isDoubleFiredEvent","triggerLocked","doubleEventList","isSizeChangeDetected","checkTolarance","a","b","isForceResizableEvent","isForceResizableHeightCalcMode","resetRequiredMethods","logIgnored","checkDownSizing","clearTimeout","triggerLockedTimer","triggerReset","hcm","sendToParent","message","postMessage","receiver","event","isMessageForUs","initFromParent","source","firstRun","initLock","resetFromParent","resizeFromParent","getMessageType","isMiddleTier","isInitMsg","true","false","resize","click","scroll","bodyScroll","documentElementScroll","parent","offset","bodyOffset","documentElementOffset","grow","lowestElement","lowestElementOnly"],"mappings":";;;;;;;;CAUC,WACA,YAmCA,SAASA,GAAiBC,EAAGC,EAAIC,GAC5B,oBAAsBC,QACzBH,EAAGD,iBAAiBE,EAAIC,GAAM,GACpB,eAAiBC,SAC3BH,EAAGI,YAAY,KAAKH,EAAIC,GAI1B,QAASG,GAAaC,GACrB,MAAOC,IAAQ,IAAMC,GAAO,KAAYF,EAGzC,QAASG,GAAIH,GACRI,GAAY,gBAAoBP,QAAOQ,SAC1CA,QAAQF,IAAIJ,EAAaC,IAI3B,QAASM,GAAKN,GACT,gBAAoBH,QAAOQ,SAC9BA,QAAQC,KAAKP,EAAaC,IAK5B,QAASO,KACRJ,EAAI,uBACJK,IACAC,IACAC,EAAa,aAAaC,GAC1BD,EAAa,UAAUE,GACvBC,IACAC,IACAC,IACAC,IACAC,IACAC,EAAcC,IACdC,EAAS,OAAO,+BAGjB,QAASZ,KAIR,QAASa,GAAQC,GAChB,MAAO,SAAWA,GAAM,GAAO,EAHhC,GAAIC,GAAOC,EAAQC,OAAOC,IAAUC,MAAM,IAM1CzB,IAAqBqB,EAAK,GAC1BK,EAAsBC,SAAcN,EAAK,GAAMO,OAAOP,EAAK,IAAQK,EACnEG,EAAsBF,SAAcN,EAAK,GAAMF,EAAQE,EAAK,IAAOQ,EACnE3B,EAAsByB,SAAcN,EAAK,GAAMF,EAAQE,EAAK,IAAOnB,EACnE4B,EAAsBH,SAAcN,EAAK,GAAMO,OAAOP,EAAK,IAAQS,EACnEC,GAAsBJ,SAAcN,EAAK,GAAMF,EAAQE,EAAK,IAAOU,GACnEC,EAAsBL,SAAcN,EAAK,GAAMF,EAAQE,EAAK,IAAOW,EACnEC,EAAqBZ,EAAK,GAC1Ba,EAAsBP,SAAcN,EAAK,GAAMA,EAAK,GAAea,EACnEzB,EAAqBY,EAAK,GAC1BX,EAAqBW,EAAK,IAC1Bc,GAAsBR,SAAcN,EAAK,IAAOO,OAAOP,EAAK,KAAOc,GACnEnB,EAAYoB,OAAUT,SAAcN,EAAK,IAAOF,EAAQE,EAAK,MAAM,EACnEgB,GAAqBhB,EAAK,IAG3B,QAASiB,GAAOC,EAAKC,GAKpB,MAJI,KAAOA,EAAMC,QAAQ,OACxBrC,EAAK,kCAAkCmC,GACvCC,EAAM,IAEAA,EAGR,QAAShC,GAAa+B,EAAKC,GACrBb,SAAca,GAAW,KAAOA,GAAW,SAAWA,IAC1DE,SAASC,KAAKC,MAAML,GAAQC,EAC5BvC,EAAI,QAAQsC,EAAK,YAAYC,EAAM,MAIrC,QAASjC,KAEJoB,SAAcM,IACjBA,EAAgBP,EAAW,MAE5BY,EAAO,SAASL,GAChBzB,EAAa,SAASyB,GAGvB,QAASpB,KACR6B,SAASG,gBAAgBD,MAAME,OAAS,GACxCJ,SAASC,KAAKC,MAAME,OAAS,GAC7B7C,EAAI,oCAIL,QAAS8C,GAAgBC,GACxB,QAASC,GAAYC,GACpB3D,EAAiBI,OAAOuD,EAAU,SAASC,GAC1CjC,EAAS8B,EAAQE,UAAUF,EAAQI,aAIlCJ,EAAQK,YAAcC,MAAMC,UAAUC,KACxCR,EAAQE,UAAYF,EAAQK,WAAW,GACvCL,EAAQK,WAAWG,IAAIP,IAEvBA,EAAYD,EAAQE,WAGrBjD,EAAI,yBAA2B+C,EAAQI,WAGxC,QAASK,KACRV,GAAkBK,UAAW,kBAA6BC,YAAa,iBAAiB,0BACxFN,GAAkBK,UAAW,sBAA6BC,YAAa,qBAAqB,8BAC5FN,GAAkBK,UAAW,gBAA6BC,YAAa,eAAe,wBACtFN,GAAkBK,UAAW,4BAA6BF,UAAY,sBACtEH,GAAkBK,UAAW,iBAA6BC,YAAa,gBAAgB,sBAAsB,kBAAkB,iBAAiB,oBAChJN,GAAkBK,UAAW,iBAA6BF,UAAY,UAGnE,UAAYb,IACdU,GAAkBK,UAAW,iBAAyBF,UAAY,WAIpE,QAAStC,KACJ8C,IAA0BxB,IACvBA,IAAkByB,MACvBvD,EAAK8B,EAAiB,uDACtBA,EAAe,cAEhBjC,EAAI,qCAAqCiC,EAAe,MAI1D,QAASnB,MACH,IAASiB,GACbyB,IACAG,KAGA3D,EAAI,wBAIN,QAASU,KACR,GAAIkD,GAAWnB,SAASoB,cAAc,MACtCD,GAASjB,MAAMmB,MAAQ,OACvBF,EAASjB,MAAMoB,QAAU,QACzBtB,SAASC,KAAKsB,YAAYJ,GAG3B,QAAS5C,KAER,QAASiD,KACR,OACCC,EAA2BxC,SAAvBhC,OAAOyE,YAA6BzE,OAAOyE,YAAc1B,SAASG,gBAAgBwB,WACtFC,EAA2B3C,SAAvBhC,OAAO4E,YAA6B5E,OAAO4E,YAAc7B,SAASG,gBAAgB2B,WAIxF,QAASC,GAAmBjF,GAC3B,GACCkF,GAAelF,EAAGmF,wBAClBC,EAAeV,GAEhB,QACCC,EAAGU,SAASH,EAAWI,KAAK,IAAMD,SAASD,EAAaT,EAAE,IAC1DG,EAAGO,SAASH,EAAWK,IAAI,IAAOF,SAASD,EAAaN,EAAE,KAI5D,QAASU,GAAWC,GAInB,QAASC,GAAaC,GACrB,GAAIC,GAAeX,EAAmBU,EAEtClF,GAAI,4BAA4BoF,EAAK,WAAWD,EAAajB,EAAE,OAAOiB,EAAad,GACnFgB,EAAQF,EAAad,EAAGc,EAAajB,EAAG,kBAPzC,GAAIkB,GAAOJ,EAASxD,MAAM,KAAK,IAAM,GACjC8D,EAAWC,mBAAmBH,GAS9BF,EAASzC,SAAS+C,eAAeF,IAAa7C,SAASgD,kBAAkBH,GAAU,EAEnFJ,GACHD,EAAaC,IAEblF,EAAI,kBAAoBoF,EAAO,+CAC/BC,EAAQ,EAAE,EAAE,aAAa,IAAID,IAI/B,QAASM,KACJ,KAAOV,SAASI,MAAQ,MAAQJ,SAASI,MAC5CL,EAAWC,SAASW,MAItB,QAASC,KACR,QAASC,GAAUtG,GAClB,QAASuG,GAAY5C,GACpBA,EAAE6C,iBAGFhB,EAAWiB,KAAKC,aAAa,SAG1B,MAAQ1G,EAAG0G,aAAa,SAC3B3G,EAAiBC,EAAG,QAAQuG,GAI9BzC,MAAMC,UAAU4C,QAAQC,KAAM1D,SAAS2D,iBAAkB,gBAAkBP,GAG5E,QAASQ,KACR/G,EAAiBI,OAAO,aAAagG,GAGtC,QAASY,KACRC,WAAWb,EAAkBc,GAG9B,QAASC,KACLpD,MAAMC,UAAU4C,SAAWzD,SAAS2D,kBACtCpG,EAAI,qCACJ4F,IACAS,IACAC,KAEAnG,EAAK,2FAUP,MANGY,GAAYoB,OACdsE,IAEAzG,EAAI,gCAIJ+E,WAAWA,GAIb,QAASlE,KACJiB,KACH9B,EAAI,yBAEJN,OAAOgH,cACNC,MAAO,WACNtB,EAAQ,EAAE,EAAE,UAEbuB,MAAO,WACN,MAAO7G,KAER8G,aAAc,SAAuBzB,GACpCrE,EAAYgE,WAAWK,IAExB0B,MAAO,WACNC,EAAY,uBAEbC,SAAU,SAAmB9C,EAAEG,GAC9BgB,EAAQhB,EAAEH,EAAE,aAEb+C,eAAgB,SAAmB/C,EAAEG,GACpCgB,EAAQhB,EAAEH,EAAE,mBAEbgD,YAAa,SAAsBrH,EAAIsH,GACtC9B,EAAQ,EAAE,EAAE,UAAU+B,KAAKC,UAAUxH,GAAKsH,IAE3CG,2BAA4B,SAAqCC,GAChEtF,EAAiBsF,EACjB5G,KAED6G,gBAAiB,SAA0BL,GAC1CnH,EAAI,qBAAqBmH,GACzBM,GAAsBN,GAEvBO,KAAM,SAAeC,EAAcC,GAClC,GAAIC,GAAY,IAAIF,EAAaA,EAAa,KAAKC,EAAY,IAAIA,EAAY,GAC/EE,KACA7G,EAAS,OAAO,qBAAqB4G,EAAU,IAAKF,EAAcC,MAMtE,QAASG,KACH,IAAMlG,IACV7B,EAAI,gBAAgB6B,EAAS,MAC7BmG,YAAY,WACX/G,EAAS,WAAW,gBAAgBY,IACnCoG,KAAKC,IAAIrG,KAIb,QAASsG,GAA+BC,GACvC,QAASC,GAAgBC,IACD5G,SAAnB4G,EAAQzF,QAA0CnB,SAAlB4G,EAAQC,OAAuB,IAAMD,EAAQzF,QAAU,IAAMyF,EAAQC,SACxGvI,EAAI,uBAAuBsI,EAAQE,KACnClJ,EAAiBgJ,EAAQ,OAAQ,WAChCrH,EAAS,YAAY,mBAKxBmH,EAAUlC,QAAQ,SAAUuC,GAC3B,GAAsB,eAAlBA,EAASC,MAAoD,QAA3BD,EAASE,cAC9CN,EAAgBI,EAASvD,YACnB,IAAsB,cAAlBuD,EAASC,KAAqB,CACxC,GAAIE,GAASH,EAASvD,OAAOkB,iBAAiB,MAC9C/C,OAAMC,UAAU4C,QAAQC,KAAKyC,EAAO,SAAUC,GAC7CR,EAAgBQ,QAMpB,QAASlF,KAIR,QAASmF,KACR,GACC5D,GAASzC,SAASsG,cAAc,QAEhCC,GACCC,YAAwB,EACxBC,mBAAwB,EACxBC,eAAwB,EACxBC,uBAAwB,EACxBC,WAAwB,EACxBC,SAAwB,GAGzBC,EAAW,GAAIC,GAAiB,SAASpB,GACxCnH,EAAS,mBAAmB,qBAAuBmH,EAAU,GAAGlD,OAAS,IAAMkD,EAAU,GAAGM,MAC5FP,EAA+BC,IAGjCpI,GAAI,2BACJuJ,EAASE,QAAQvE,EAAQ8D,GArB1B,GAAIQ,GAAmB9J,OAAO8J,kBAAoB9J,OAAOgK,sBAwBrDF,GACC,EAAI3H,EACPkG,IAEAe,KAID3I,EAAK,mDACL4H,KAOF,QAAS4B,KACR,QAASC,GAAqBC,GAC7B,QAASC,GAAuBvH,GAC/B,GAAIwH,GAAQ,aAEZ,IAAIA,EAAMC,KAAKzH,GACd,MAAOqC,UAASrC,EAAM0H,EAGvB,IACCtH,GAAQpD,EAAGoD,MAAMkC,KACjBqF,EAAe3K,EAAG2K,aAAarF,IAQhC,OANAtF,GAAG2K,aAAarF,KAAOtF,EAAG4K,aAAatF,KACvCtF,EAAGoD,MAAMkC,KAAOtC,GAAS,EACzBA,EAAQhD,EAAGoD,MAAMyH,UACjB7K,EAAGoD,MAAMkC,KAAOlC,EAChBpD,EAAG2K,aAAarF,KAAOqF,EAEhB3H,EAGR,GACChD,GAAKkD,SAASC,KACd2H,EAAS,CASV,OAPK,eAAiB5H,WAAc,oBAAsBA,UAAS6H,aAClED,EAAS5H,SAAS6H,YAAYC,iBAAiBhL,EAAI,MACnD8K,EAAU,OAASA,EAAUA,EAAOR,GAAQ,GAE5CQ,EAAUP,EAAuBvK,EAAG4K,aAAaN,IAG3CjF,SAASyF,EAAOJ,GAGxB,MAAQxH,UAASC,KAAK8H,aACpBZ,EAAqB,aACrBA,EAAqB,gBAGxB,QAASa,KACR,MAAOhI,UAASC,KAAKgI,aAGtB,QAASC,KACR,MAAOlI,UAASG,gBAAgB4H,aAGjC,QAASI,KACR,MAAOnI,UAASG,gBAAgB8H,aAIjC,QAASG,KAOR,IAAK,GALJC,GAAoBrI,SAAS2D,iBAAiB,UAC9C2E,EAAoBD,EAAYE,OAChCC,EAAoB,EACpBC,GAAoB,GAAIC,OAAOC,UAEvBC,EAAI,EAAON,EAAJM,EAAuBA,IAClCP,EAAYO,GAAG3G,wBAAwB4G,OAASL,IACnDA,EAAeH,EAAYO,GAAG3G,wBAAwB4G,OASxD,OALAJ,IAAQ,GAAIC,OAAOC,UAAYF,EAE/BlL,EAAI,UAAU+K,EAAkB,kBAChC/K,EAAI,+CAAiDkL,EAAQ,MAEtDD,EAGR,QAASM,KACR,OACC5B,IACAc,IACAE,IACAC,KAIF,QAASY,KACR,MAAOvD,MAAKwD,IAAIC,MAAM,KAAKH,KAG5B,QAASI,KACR,MAAO1D,MAAK2D,IAAIF,MAAM,KAAKH,KAG5B,QAASM,KACR,MAAO5D,MAAKwD,IAAI9B,IAAsBkB,KAiBvC,QAASiB,KACR,MAAO7D,MAAKwD,IACXhJ,SAASG,gBAAgBmJ,YACzBtJ,SAASC,KAAKqJ,aAIhB,QAAS9K,GAAS+K,EAAcC,EAAkBtE,EAAcC,GAI/D,QAASsE,KACFF,KAAiBlF,MAAQ,EAAEqF,UAAY,EAAE/L,KAAO,IACrDJ,EAAK,kBAAoBiM,GAI3B,QAASG,KACRvJ,EAASwJ,EACT9D,GAAS+D,EAETjH,EAAQxC,EAAO0F,GAAMyD,GAGtB,QAASO,KACR,MAAQC,KAAkBR,IAAgBS,GAG3C,QAASC,KACR,QAASC,GAAeC,EAAEC,GACzB,GAAIxC,GAASpC,KAAKC,IAAI0E,EAAEC,IAAM3K,EAC9B,QAAQmI,EAMT,MAHAgC,GAAiB3K,SAAciG,EAAiBA,EAAejE,GAAUzB,KACzEqK,EAAiB5K,SAAckG,EAAiBA,EAAekE,IAExDa,EAAe9J,EAAOwJ,IAC1BzK,GAAkB+K,EAAepE,GAAM+D,GAG3C,QAASQ,KACR,QAASd,KAAiB5L,KAAO,EAAEyB,SAAW,EAAE6F,KAAO,IAGxD,QAASqF,KACR,MAAQ9K,KAAkB+K,IAG3B,QAASC,KACRjN,EAAI,8BAGL,QAASkN,KACJJ,KAA2BC,IAC9BhG,EAAYkF,GACAD,KAAiBnK,SAAW,KACxCqK,IACAe,KAjDF,GAAIZ,GAAcC,CAqDbC,KASJvM,EAAI,4BAA4BgM,GAR5BU,KACHR,IACApE,IACAsE,KAEAc,IAOH,QAASpF,KACH0E,KACJA,IAAgB,EAChBxM,EAAI,0BAELmN,aAAaC,IACbA,GAAqB7G,WAAW,WAC/BiG,IAAgB,EAChBxM,EAAI,0BACJA,EAAI,OACHwG,GAGH,QAAS6G,GAAarB,GACrBnJ,EAASa,GAAUzB,KACnBsG,GAASuD,IAETzG,EAAQxC,EAAO0F,GAAMyD,GAGtB,QAASjF,GAAYkF,GACpB,GAAIqB,GAAMrL,CACVA,GAAiBwB,EAEjBzD,EAAI,wBAA0BiM,GAC9BnE,IACAuF,EAAa,SAEbpL,EAAiBqL,EAGlB,QAASjI,GAAQxC,EAAO0F,EAAMyD,EAAanM,EAAIsH,GAC9C,QAASK,KACJ9F,SAAcyF,EACjBA,EAAeM,GAEfzH,EAAI,yBAAyBmH,GAI/B,QAASoG,KACR,GACC7F,GAAQ7E,EAAS,IAAM0F,EACvBiF,EAAUzN,GAAO,IAAO2H,EAAO,IAAMsE,GAAgBtK,SAAc7B,EAAM,IAAMA,EAAM,GAEtFG,GAAI,iCAAmCwN,EAAU,KACjDtI,GAAOuI,YAAa3N,GAAQ0N,EAASrG,GAGtCK,IACA+F,IAGD,QAASG,GAASC,GACjB,QAASC,KACR,MAAO9N,OAAW,GAAG6N,EAAMvM,MAAME,OAAO,EAAEC,IAG3C,QAASsM,KACRxM,EAAUsM,EAAMvM,KAChB8D,GAAUyI,EAAMG,OAEhB1N,IACA2N,GAAW,EACXxH,WAAW,WAAYyH,GAAW,GAAQxH,GAG3C,QAASyH,KACHD,EAIJhO,EAAI,+BAHJA,EAAI,gCACJqN,EAAa,cAMf,QAASa,KACRjN,EAAS,eAAe,yBAGzB,QAASkN,KACR,MAAOR,GAAMvM,KAAKI,MAAM,KAAK,GAG9B,QAAS4M,KACR,MAAQ,gBAAkB1O,QAG3B,QAAS2O,KAGR,MAAOV,GAAMvM,KAAKI,MAAM,KAAK,KAAO8M,OAAO,EAAEC,QAAQ,GAGlDX,MACCG,KAAa,EACZ,UAAYI,IACfF,IACU,WAAaE,IACvBD,IACUP,EAAMvM,OAASC,GAAY+M,KACrCjO,EAAK,uBAAuBwN,EAAMvM,KAAK,KAE9BiN,IACVR,IAEA1N,EAAK,6BAA6BgO,IAAiB,6BA/qBtD,GACCpM,IAAwB,EACxBkI,EAAwB,GACxBzJ,EAAwB,GACxBiB,EAAwB,EACxBO,EAAwB,GACxBvB,EAAwB,GACxBmB,GAAwB,EACxB6K,GAAyB+B,OAAS,EAAEC,MAAQ,GAC5CjI,EAAwB,IACxB3D,EAAwB,EACxBkL,GAAwB,EACxBtK,EAAwB,SACxBxB,EAAwBwB,EACxBuK,GAAwB,EACxB3M,EAAwB,GACxBN,KACAc,EAAwB,GACxB5B,GAAwB,EACxBH,GAAwB,gBACxByB,GAAwBzB,GAAMkL,OAC9BjL,GAAwB,GACxB+B,IAAwB,EACxBkL,IAAyBvB,IAAI,EAAEiD,OAAO,EAAEC,WAAW,EAAEC,sBAAsB,GAC3ExM,GAAwB,SACxBqF,GAAwB,IACxBvC,GAAwBxF,OAAOmP,OAC/B3M,GAAwB,EACxBsK,IAAwB,EACxBY,GAAwB,KACxB7E,GAAwB,EA8crB7E,IACHoL,OAAwBnF,EACxBoF,WAAwBpF,EACxBgF,WAAwBlE,EACxBuE,sBAAwBrE,EACxB+D,OAAwB9D,EACxBgE,sBAAwBhE,EACxBa,IAAwBD,EACxBI,IAAwBD,EACxBsD,KAAwBzD,EACxB0D,cAAwBrD,EACxBsD,kBAAwBtE,EA6LzBvL,GAAiBI,OAAQ,UAAWgO","sourcesContent":["/*\r\n * File: iframeResizer.contentWindow.js\r\n * Desc: Include this file in any page being loaded into an iframe\r\n *       to force the iframe to resize to the content size.\r\n * Requires: iframeResizer.js on host page.\r\n * Author: David J. Bradshaw - dave@bradshaw.net\r\n * Contributor: Jure Mav - jure.mav@gmail.com\r\n * Contributor: Ian Caunce - ian@hallnet.co.uk\r\n */\r\n\r\n;(function() {\r\n\t'use strict';\r\n\r\n\tvar\r\n\t\tautoResize            = true,\r\n\t\tbase                  = 10,\r\n\t\tbodyBackground        = '',\r\n\t\tbodyMargin            = 0,\r\n\t\tbodyMarginStr         = '',\r\n\t\tbodyPadding           = '',\r\n\t\tcalculateWidth        = false,\r\n\t\tdoubleEventList       = {'resize':1,'click':1},\r\n\t\teventCancelTimer      = 128,\r\n\t\theight                = 1,\r\n\t\tfirstRun              = true,\r\n\t\theightCalcModeDefault = 'offset',\r\n\t\theightCalcMode        = heightCalcModeDefault,\r\n\t\tinitLock              = true,\r\n\t\tinitMsg               = '',\r\n\t\tinPageLinks           = {},\r\n\t\tinterval              = 32,\r\n\t\tlogging               = false,\r\n\t\tmsgID                 = '[iFrameSizer]',  //Must match host page msg ID\r\n\t\tmsgIdLen              = msgID.length,\r\n\t\tmyID                  = '',\r\n\t\tpublicMethods         = false,\r\n\t\tresetRequiredMethods  = {max:1,scroll:1,bodyScroll:1,documentElementScroll:1},\r\n\t\tresizeFrom            = 'parent',\r\n\t\ttargetOriginDefault   = '*',\r\n\t\ttarget                = window.parent,\r\n\t\ttolerance             = 0,\r\n\t\ttriggerLocked         = false,\r\n\t\ttriggerLockedTimer    = null,\r\n\t\twidth                 = 1;\r\n\r\n\r\n\tfunction addEventListener(el,evt,func){\r\n\t\tif ('addEventListener' in window){\r\n\t\t\tel.addEventListener(evt,func, false);\r\n\t\t} else if ('attachEvent' in window){ //IE\r\n\t\t\tel.attachEvent('on'+evt,func);\r\n\t\t}\r\n\t}\r\n\r\n\tfunction formatLogMsg(msg){\r\n\t\treturn msgID + '[' + myID + ']' + ' ' + msg;\r\n\t}\r\n\r\n\tfunction log(msg){\r\n\t\tif (logging && ('object' === typeof window.console)){\r\n\t\t\tconsole.log(formatLogMsg(msg));\r\n\t\t}\r\n\t}\r\n\r\n\tfunction warn(msg){\r\n\t\tif ('object' === typeof window.console){\r\n\t\t\tconsole.warn(formatLogMsg(msg));\r\n\t\t}\r\n\t}\r\n\r\n\r\n\tfunction init(){\r\n\t\tlog('Initialising iFrame');\r\n\t\treadData();\r\n\t\tsetMargin();\r\n\t\tsetBodyStyle('background',bodyBackground);\r\n\t\tsetBodyStyle('padding',bodyPadding);\r\n\t\tinjectClearFixIntoBodyElement();\r\n\t\tcheckHeightMode();\r\n\t\tstopInfiniteResizingOfIFrame();\r\n\t\tsetupPublicMethods();\r\n\t\tstartEventListeners();\r\n\t\tinPageLinks = setupInPageLinks();\r\n\t\tsendSize('init','Init message from host page');\r\n\t}\r\n\r\n\tfunction readData(){\r\n\r\n\t\tvar data = initMsg.substr(msgIdLen).split(':');\r\n\r\n\t\tfunction strBool(str){\r\n\t\t\treturn 'true' === str ? true : false;\r\n\t\t}\r\n\r\n\t\tmyID               = data[0];\r\n\t\tbodyMargin         = (undefined !== data[1]) ? Number(data[1])   : bodyMargin; //For V1 compatibility\r\n\t\tcalculateWidth     = (undefined !== data[2]) ? strBool(data[2])  : calculateWidth;\r\n\t\tlogging            = (undefined !== data[3]) ? strBool(data[3])  : logging;\r\n\t\tinterval           = (undefined !== data[4]) ? Number(data[4])   : interval;\r\n\t\tpublicMethods      = (undefined !== data[5]) ? strBool(data[5])  : publicMethods;\r\n\t\tautoResize         = (undefined !== data[6]) ? strBool(data[6])  : autoResize;\r\n\t\tbodyMarginStr      = data[7];\r\n\t\theightCalcMode     = (undefined !== data[8]) ? data[8]           : heightCalcMode;\r\n\t\tbodyBackground     = data[9];\r\n\t\tbodyPadding        = data[10];\r\n\t\ttolerance          = (undefined !== data[11]) ? Number(data[11]) : tolerance;\r\n\t\tinPageLinks.enable = (undefined !== data[12]) ? strBool(data[12]): false;\r\n\t\tresizeFrom         = data[13];\r\n\t}\r\n\r\n\tfunction chkCSS(attr,value){\r\n\t\tif (-1 !== value.indexOf('-')){\r\n\t\t\twarn('Negative CSS value ignored for '+attr);\r\n\t\t\tvalue='';\r\n\t\t}\r\n\t\treturn value;\r\n\t}\r\n\r\n\tfunction setBodyStyle(attr,value){\r\n\t\tif ((undefined !== value) && ('' !== value) && ('null' !== value)){\r\n\t\t\tdocument.body.style[attr] = value;\r\n\t\t\tlog('Body '+attr+' set to \"'+value+'\"');\r\n\t\t}\r\n\t}\r\n\r\n\tfunction setMargin(){\r\n\t\t//If called via V1 script, convert bodyMargin from int to str\r\n\t\tif (undefined === bodyMarginStr){\r\n\t\t\tbodyMarginStr = bodyMargin+'px';\r\n\t\t}\r\n\t\tchkCSS('margin',bodyMarginStr);\r\n\t\tsetBodyStyle('margin',bodyMarginStr);\r\n\t}\r\n\r\n\tfunction stopInfiniteResizingOfIFrame(){\r\n\t\tdocument.documentElement.style.height = '';\r\n\t\tdocument.body.style.height = '';\r\n\t\tlog('HTML & body height set to \"auto\"');\r\n\t}\r\n\r\n\r\n\tfunction addTriggerEvent(options){\r\n\t\tfunction addListener(eventName){\r\n\t\t\taddEventListener(window,eventName,function(e){\r\n\t\t\t\tsendSize(options.eventName,options.eventType);\r\n\t\t\t});\r\n\t\t}\r\n\r\n\t\tif(options.eventNames && Array.prototype.map){\r\n\t\t\toptions.eventName = options.eventNames[0];\r\n\t\t\toptions.eventNames.map(addListener);\r\n\t\t} else {\r\n\t\t\taddListener(options.eventName);\r\n\t\t}\r\n\r\n\t\tlog('Added event listener: ' + options.eventType);\r\n\t}\r\n\r\n\tfunction initEventListeners(){\r\n\t\taddTriggerEvent({ eventType: 'Animation Start',           eventNames: ['animationstart','webkitAnimationStart'] });\r\n\t\taddTriggerEvent({ eventType: 'Animation Iteration',       eventNames: ['animationiteration','webkitAnimationIteration'] });\r\n\t\taddTriggerEvent({ eventType: 'Animation End',             eventNames: ['animationend','webkitAnimationEnd'] });\r\n\t\taddTriggerEvent({ eventType: 'Device Orientation Change', eventName:  'deviceorientation' });\r\n\t\taddTriggerEvent({ eventType: 'Transition End',            eventNames: ['transitionend','webkitTransitionEnd','MSTransitionEnd','oTransitionEnd','otransitionend'] });\r\n\t\taddTriggerEvent({ eventType: 'Window Clicked',            eventName:  'click' });\r\n\t\t//addTriggerEvent({ eventType: 'Window Mouse Down',         eventName:  'mousedown' });\r\n\t\t//addTriggerEvent({ eventType: 'Window Mouse Up',           eventName:  'mouseup' });\r\n\t\tif('child' === resizeFrom){\r\n\t\t\taddTriggerEvent({ eventType: 'IFrame Resized',        eventName:  'resize' });\r\n\t\t}\r\n\t}\r\n\r\n\tfunction checkHeightMode(){\r\n\t\tif (heightCalcModeDefault !== heightCalcMode){\r\n\t\t\tif (!(heightCalcMode in getHeight)){\r\n\t\t\t\twarn(heightCalcMode + ' is not a valid option for heightCalculationMethod.');\r\n\t\t\t\theightCalcMode='bodyScroll';\r\n\t\t\t}\r\n\t\t\tlog('Height calculation method set to \"'+heightCalcMode+'\"');\r\n\t\t}\r\n\t}\r\n\r\n\tfunction startEventListeners(){\r\n\t\tif ( true === autoResize ) {\r\n\t\t\tinitEventListeners();\r\n\t\t\tsetupMutationObserver();\r\n\t\t}\r\n\t\telse {\r\n\t\t\tlog('Auto Resize disabled');\r\n\t\t}\r\n\t}\r\n\r\n\tfunction injectClearFixIntoBodyElement(){\r\n\t\tvar clearFix = document.createElement('div');\r\n\t\tclearFix.style.clear = 'both';\r\n\t\tclearFix.style.display = 'block'; //Guard against this having been globally redefined in CSS.\r\n\t\tdocument.body.appendChild(clearFix);\r\n\t}\r\n\r\n\tfunction setupInPageLinks(){\r\n\r\n\t\tfunction getPagePosition (){\r\n\t\t\treturn {\r\n\t\t\t\tx: (window.pageXOffset !== undefined) ? window.pageXOffset : document.documentElement.scrollLeft,\r\n\t\t\t\ty: (window.pageYOffset !== undefined) ? window.pageYOffset : document.documentElement.scrollTop\r\n\t\t\t};\r\n\t\t}\r\n\r\n\t\tfunction getElementPosition(el){\r\n\t\t\tvar\r\n\t\t\t\telPosition   = el.getBoundingClientRect(),\r\n\t\t\t\tpagePosition = getPagePosition();\r\n\r\n\t\t\treturn {\r\n\t\t\t\tx: parseInt(elPosition.left,10) + parseInt(pagePosition.x,10),\r\n\t\t\t\ty: parseInt(elPosition.top,10)  + parseInt(pagePosition.y,10)\r\n\t\t\t};\r\n\t\t}\r\n\r\n\t\tfunction findTarget(location){\r\n\t\t\tvar hash = location.split(\"#\")[1] || \"\";\r\n\t\t\tvar hashData = decodeURIComponent(hash);\r\n\r\n\t\t\tfunction jumpToTarget(target){\r\n\t\t\t\tvar jumpPosition = getElementPosition(target);\r\n\r\n\t\t\t\tlog('Moving to in page link (#'+hash+') at x: '+jumpPosition.x+' y: '+jumpPosition.y);\r\n\t\t\t\tsendMsg(jumpPosition.y, jumpPosition.x, 'scrollToOffset'); // X&Y reversed at sendMsg uses height/width\r\n\t\t\t}\r\n\r\n\t\t\tvar target = document.getElementById(hashData) || document.getElementsByName(hashData)[0];\r\n\r\n\t\t\tif (target){\r\n\t\t\t\tjumpToTarget(target);\r\n\t\t\t} else {\r\n\t\t\t\tlog('In page link (#' + hash + ') not found in iFrame, so sending to parent');\r\n\t\t\t\tsendMsg(0,0,'inPageLink','#'+hash);\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tfunction checkLocationHash(){\r\n\t\t\tif ('' !== location.hash && '#' !== location.hash){\r\n\t\t\t\tfindTarget(location.href);\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tfunction bindAnchors(){\r\n\t\t\tfunction setupLink(el){\r\n\t\t\t\tfunction linkClicked(e){\r\n\t\t\t\t\te.preventDefault();\r\n\r\n\t\t\t\t\t/*jshint validthis:true */\r\n\t\t\t\t\tfindTarget(this.getAttribute('href'));\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif ('#' !== el.getAttribute('href')){\r\n\t\t\t\t\taddEventListener(el,'click',linkClicked);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tArray.prototype.forEach.call( document.querySelectorAll( 'a[href^=\"#\"]' ), setupLink );\r\n\t\t}\r\n\r\n\t\tfunction bindLocationHash(){\r\n\t\t\taddEventListener(window,'hashchange',checkLocationHash);\r\n\t\t}\r\n\r\n\t\tfunction initCheck(){ //check if page loaded with location hash after init resize\r\n\t\t\tsetTimeout(checkLocationHash,eventCancelTimer);\r\n\t\t}\r\n\r\n\t\tfunction enableInPageLinks(){\r\n\t\t\tif(Array.prototype.forEach && document.querySelectorAll){\r\n\t\t\t\tlog('Setting up location.hash handlers');\r\n\t\t\t\tbindAnchors();\r\n\t\t\t\tbindLocationHash();\r\n\t\t\t\tinitCheck();\r\n\t\t\t} else {\r\n\t\t\t\twarn('In page linking not fully supported in this browser! (See README.md for IE8 workaround)');\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif(inPageLinks.enable){\r\n\t\t\tenableInPageLinks();\r\n\t\t} else {\r\n\t\t\tlog('In page linking not enabled');\r\n\t\t}\r\n\r\n\t\treturn {\r\n\t\t\tfindTarget:findTarget\r\n\t\t};\r\n\t}\r\n\r\n\tfunction setupPublicMethods(){\r\n\t\tif (publicMethods) {\r\n\t\t\tlog('Enable public methods');\r\n\r\n\t\t\twindow.parentIFrame = {\r\n\t\t\t\tclose: function closeF(){\r\n\t\t\t\t\tsendMsg(0,0,'close');\r\n\t\t\t\t},\r\n\t\t\t\tgetId: function getIdF(){\r\n\t\t\t\t\treturn myID;\r\n\t\t\t\t},\r\n\t\t\t\tmoveToAnchor: function moveToAnchorF(hash){\r\n\t\t\t\t\tinPageLinks.findTarget(hash);\r\n\t\t\t\t},\r\n\t\t\t\treset: function resetF(){\r\n\t\t\t\t\tresetIFrame('parentIFrame.reset');\r\n\t\t\t\t},\r\n\t\t\t\tscrollTo: function scrollToF(x,y){\r\n\t\t\t\t\tsendMsg(y,x,'scrollTo'); // X&Y reversed at sendMsg uses height/width\r\n\t\t\t\t},\r\n\t\t\t\tscrollToOffset: function scrollToF(x,y){\r\n\t\t\t\t\tsendMsg(y,x,'scrollToOffset'); // X&Y reversed at sendMsg uses height/width\r\n\t\t\t\t},\r\n\t\t\t\tsendMessage: function sendMessageF(msg,targetOrigin){\r\n\t\t\t\t\tsendMsg(0,0,'message',JSON.stringify(msg),targetOrigin);\r\n\t\t\t\t},\r\n\t\t\t\tsetHeightCalculationMethod: function setHeightCalculationMethodF(heightCalculationMethod){\r\n\t\t\t\t\theightCalcMode = heightCalculationMethod;\r\n\t\t\t\t\tcheckHeightMode();\r\n\t\t\t\t},\r\n\t\t\t\tsetTargetOrigin: function setTargetOriginF(targetOrigin){\r\n\t\t\t\t\tlog('Set targetOrigin: '+targetOrigin);\r\n\t\t\t\t\ttargetOriginDefault = targetOrigin;\r\n\t\t\t\t},\r\n\t\t\t\tsize: function sizeF(customHeight, customWidth){\r\n\t\t\t\t\tvar valString = ''+(customHeight?customHeight:'')+(customWidth?','+customWidth:'');\r\n\t\t\t\t\tlockTrigger();\r\n\t\t\t\t\tsendSize('size','parentIFrame.size('+valString+')', customHeight, customWidth);\r\n\t\t\t\t}\r\n\t\t\t};\r\n\t\t}\r\n\t}\r\n\r\n\tfunction initInterval(){\r\n\t\tif ( 0 !== interval ){\r\n\t\t\tlog('setInterval: '+interval+'ms');\r\n\t\t\tsetInterval(function(){\r\n\t\t\t\tsendSize('interval','setInterval: '+interval);\r\n\t\t\t},Math.abs(interval));\r\n\t\t}\r\n\t}\r\n\r\n\tfunction setupInjectElementLoadListners(mutations){\r\n\t\tfunction addLoadListener(element){\r\n\t\t\tif (element.height === undefined || element.width === undefined || 0 === element.height || 0 === element.width){\r\n\t\t\t\tlog('Attach listerner to '+element.src);\r\n\t\t\t\taddEventListener(element,'load', function imageLoaded(){\r\n\t\t\t\t\tsendSize('imageLoad','Image loaded');\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tmutations.forEach(function (mutation) {\r\n\t\t\tif (mutation.type === 'attributes' && mutation.attributeName === 'src'){\r\n\t\t\t\taddLoadListener(mutation.target);\r\n\t\t\t} else if (mutation.type === 'childList'){\r\n\t\t\t\tvar images = mutation.target.querySelectorAll('img');\r\n\t\t\t\tArray.prototype.forEach.call(images,function (image) {\r\n\t\t\t\t\taddLoadListener(image);\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tfunction setupMutationObserver(){\r\n\r\n\t\tvar MutationObserver = window.MutationObserver || window.WebKitMutationObserver;\r\n\r\n\t\tfunction createMutationObserver(){\r\n\t\t\tvar\r\n\t\t\t\ttarget = document.querySelector('body'),\r\n\r\n\t\t\t\tconfig = {\r\n\t\t\t\t\tattributes            : true,\r\n\t\t\t\t\tattributeOldValue     : false,\r\n\t\t\t\t\tcharacterData         : true,\r\n\t\t\t\t\tcharacterDataOldValue : false,\r\n\t\t\t\t\tchildList             : true,\r\n\t\t\t\t\tsubtree               : true\r\n\t\t\t\t},\r\n\r\n\t\t\t\tobserver = new MutationObserver(function(mutations) {\r\n\t\t\t\t\tsendSize('mutationObserver','mutationObserver: ' + mutations[0].target + ' ' + mutations[0].type);\r\n\t\t\t\t\tsetupInjectElementLoadListners(mutations); //Deal with WebKit asyncing image loading when tags are injected into the page\r\n\t\t\t\t});\r\n\r\n\t\t\tlog('Enable MutationObserver');\r\n\t\t\tobserver.observe(target, config);\r\n\t\t}\r\n\r\n\t\tif (MutationObserver){\r\n\t\t\tif (0 > interval) {\r\n\t\t\t\tinitInterval();\r\n\t\t\t} else {\r\n\t\t\t\tcreateMutationObserver();\r\n\t\t\t}\r\n\t\t}\r\n\t\telse {\r\n\t\t\twarn('MutationObserver not supported in this browser!');\r\n\t\t\tinitInterval();\r\n\t\t}\r\n\t}\r\n\r\n\r\n\t// document.documentElement.offsetHeight is not reliable, so\r\n\t// we have to jump through hoops to get a better value.\r\n\tfunction getBodyOffsetHeight(){\r\n\t\tfunction getComputedBodyStyle(prop) {\r\n\t\t\tfunction convertUnitsToPxForIE8(value) {\r\n\t\t\t\tvar PIXEL = /^\\d+(px)?$/i;\r\n\r\n\t\t\t\tif (PIXEL.test(value)) {\r\n\t\t\t\t\treturn parseInt(value,base);\r\n\t\t\t\t}\r\n\r\n\t\t\t\tvar\r\n\t\t\t\t\tstyle = el.style.left,\r\n\t\t\t\t\truntimeStyle = el.runtimeStyle.left;\r\n\r\n\t\t\t\tel.runtimeStyle.left = el.currentStyle.left;\r\n\t\t\t\tel.style.left = value || 0;\r\n\t\t\t\tvalue = el.style.pixelLeft;\r\n\t\t\t\tel.style.left = style;\r\n\t\t\t\tel.runtimeStyle.left = runtimeStyle;\r\n\r\n\t\t\t\treturn value;\r\n\t\t\t}\r\n\r\n\t\t\tvar\r\n\t\t\t\tel = document.body,\r\n\t\t\t\tretVal = 0;\r\n\r\n\t\t\tif (('defaultView' in document) && ('getComputedStyle' in document.defaultView)) {\r\n\t\t\t\tretVal = document.defaultView.getComputedStyle(el, null);\r\n\t\t\t\tretVal = (null !== retVal) ? retVal[prop] : 0;\r\n\t\t\t} else {//IE8\r\n\t\t\t\tretVal =  convertUnitsToPxForIE8(el.currentStyle[prop]);\r\n\t\t\t}\r\n\r\n\t\t\treturn parseInt(retVal,base);\r\n\t\t}\r\n\r\n\t\treturn  document.body.offsetHeight +\r\n\t\t\t\tgetComputedBodyStyle('marginTop') +\r\n\t\t\t\tgetComputedBodyStyle('marginBottom');\r\n\t}\r\n\r\n\tfunction getBodyScrollHeight(){\r\n\t\treturn document.body.scrollHeight;\r\n\t}\r\n\r\n\tfunction getDEOffsetHeight(){\r\n\t\treturn document.documentElement.offsetHeight;\r\n\t}\r\n\r\n\tfunction getDEScrollHeight(){\r\n\t\treturn document.documentElement.scrollHeight;\r\n\t}\r\n\r\n\t//From https://github.com/guardian/iframe-messenger\r\n\tfunction getLowestElementHeight() {\r\n\t\tvar\r\n\t\t\tallElements       = document.querySelectorAll('body *'),\r\n\t\t\tallElementsLength = allElements.length,\r\n\t\t\tmaxBottomVal      = 0,\r\n\t\t\ttimer             = new Date().getTime();\r\n\r\n\t\tfor (var i = 0; i < allElementsLength; i++) {\r\n\t\t\tif (allElements[i].getBoundingClientRect().bottom > maxBottomVal) {\r\n\t\t\t\tmaxBottomVal = allElements[i].getBoundingClientRect().bottom;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\ttimer = new Date().getTime() - timer;\r\n\r\n\t\tlog('Parsed '+allElementsLength+' HTML elements');\r\n\t\tlog('LowestElement bottom position calculated in ' + timer + 'ms');\r\n\r\n\t\treturn maxBottomVal;\r\n\t}\r\n\r\n\tfunction getAllHeights(){\r\n\t\treturn [\r\n\t\t\tgetBodyOffsetHeight(),\r\n\t\t\tgetBodyScrollHeight(),\r\n\t\t\tgetDEOffsetHeight(),\r\n\t\t\tgetDEScrollHeight()\r\n\t\t];\r\n\t}\r\n\r\n\tfunction getMaxHeight(){\r\n\t\treturn Math.max.apply(null,getAllHeights());\r\n\t}\r\n\r\n\tfunction getMinHeight(){\r\n\t\treturn Math.min.apply(null,getAllHeights());\r\n\t}\r\n\r\n\tfunction getBestHeight(){\r\n\t\treturn Math.max(getBodyOffsetHeight(),getLowestElementHeight());\r\n\t}\r\n\r\n\tvar getHeight = {\r\n\t\toffset                : getBodyOffsetHeight, //Backward compatability\r\n\t\tbodyOffset            : getBodyOffsetHeight,\r\n\t\tbodyScroll            : getBodyScrollHeight,\r\n\t\tdocumentElementOffset : getDEOffsetHeight,\r\n\t\tscroll                : getDEScrollHeight, //Backward compatability\r\n\t\tdocumentElementScroll : getDEScrollHeight,\r\n\t\tmax                   : getMaxHeight,\r\n\t\tmin                   : getMinHeight,\r\n\t\tgrow                  : getMaxHeight,\r\n\t\tlowestElement         : getBestHeight,\r\n\t\tlowestElementOnly     : getLowestElementHeight\r\n\t};\r\n\r\n\tfunction getWidth(){\r\n\t\treturn Math.max(\r\n\t\t\tdocument.documentElement.scrollWidth,\r\n\t\t\tdocument.body.scrollWidth\r\n\t\t);\r\n\t}\r\n\r\n\tfunction sendSize(triggerEvent, triggerEventDesc, customHeight, customWidth){\r\n\r\n\t\tvar\tcurrentHeight,currentWidth;\r\n\r\n\t\tfunction recordTrigger(){\r\n\t\t\tif (!(triggerEvent in {'reset':1,'resetPage':1,'init':1})){\r\n\t\t\t\tlog( 'Trigger event: ' + triggerEventDesc );\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tfunction resizeIFrame(){\r\n\t\t\theight = currentHeight;\r\n\t\t\twidth  = currentWidth;\r\n\r\n\t\t\tsendMsg(height,width,triggerEvent);\r\n\t\t}\r\n\r\n\t\tfunction isDoubleFiredEvent(){\r\n\t\t\treturn  triggerLocked && (triggerEvent in doubleEventList);\r\n\t\t}\r\n\r\n\t\tfunction isSizeChangeDetected(){\r\n\t\t\tfunction checkTolarance(a,b){\r\n\t\t\t\tvar retVal = Math.abs(a-b) <= tolerance;\r\n\t\t\t\treturn !retVal;\r\n\t\t\t}\r\n\r\n\t\t\tcurrentHeight = (undefined !== customHeight)  ? customHeight : getHeight[heightCalcMode]();\r\n\t\t\tcurrentWidth  = (undefined !== customWidth )  ? customWidth  : getWidth();\r\n\r\n\t\t\treturn\tcheckTolarance(height,currentHeight) ||\r\n\t\t\t\t\t(calculateWidth && checkTolarance(width,currentWidth));\r\n\t\t}\r\n\r\n\t\tfunction isForceResizableEvent(){\r\n\t\t\treturn !(triggerEvent in {'init':1,'interval':1,'size':1});\r\n\t\t}\r\n\r\n\t\tfunction isForceResizableHeightCalcMode(){\r\n\t\t\treturn (heightCalcMode in resetRequiredMethods);\r\n\t\t}\r\n\r\n\t\tfunction logIgnored(){\r\n\t\t\tlog('No change in size detected');\r\n\t\t}\r\n\r\n\t\tfunction checkDownSizing(){\r\n\t\t\tif (isForceResizableEvent() && isForceResizableHeightCalcMode()){\r\n\t\t\t\tresetIFrame(triggerEventDesc);\r\n\t\t\t} else if (!(triggerEvent in {'interval':1})){\r\n\t\t\t\trecordTrigger();\r\n\t\t\t\tlogIgnored();\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif (!isDoubleFiredEvent()){\r\n\t\t\tif (isSizeChangeDetected()){\r\n\t\t\t\trecordTrigger();\r\n\t\t\t\tlockTrigger();\r\n\t\t\t\tresizeIFrame();\r\n\t\t\t} else {\r\n\t\t\t\tcheckDownSizing();\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\tlog('Trigger event cancelled: '+triggerEvent);\r\n\t\t}\r\n\t}\r\n\r\n\tfunction lockTrigger(){\r\n\t\tif (!triggerLocked){\r\n\t\t\ttriggerLocked = true;\r\n\t\t\tlog('Trigger event lock on');\r\n\t\t}\r\n\t\tclearTimeout(triggerLockedTimer);\r\n\t\ttriggerLockedTimer = setTimeout(function(){\r\n\t\t\ttriggerLocked = false;\r\n\t\t\tlog('Trigger event lock off');\r\n\t\t\tlog('--');\r\n\t\t},eventCancelTimer);\r\n\t}\r\n\r\n\tfunction triggerReset(triggerEvent){\r\n\t\theight = getHeight[heightCalcMode]();\r\n\t\twidth  = getWidth();\r\n\r\n\t\tsendMsg(height,width,triggerEvent);\r\n\t}\r\n\r\n\tfunction resetIFrame(triggerEventDesc){\r\n\t\tvar hcm = heightCalcMode;\r\n\t\theightCalcMode = heightCalcModeDefault;\r\n\r\n\t\tlog('Reset trigger event: ' + triggerEventDesc);\r\n\t\tlockTrigger();\r\n\t\ttriggerReset('reset');\r\n\r\n\t\theightCalcMode = hcm;\r\n\t}\r\n\r\n\tfunction sendMsg(height,width,triggerEvent,msg,targetOrigin){\r\n\t\tfunction setTargetOrigin(){\r\n\t\t\tif (undefined === targetOrigin){\r\n\t\t\t\ttargetOrigin = targetOriginDefault;\r\n\t\t\t} else {\r\n\t\t\t\tlog('Message targetOrigin: '+targetOrigin);\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tfunction sendToParent(){\r\n\t\t\tvar\r\n\t\t\t\tsize  = height + ':' + width,\r\n\t\t\t\tmessage = myID + ':' +  size + ':' + triggerEvent + (undefined !== msg ? ':' + msg : '');\r\n\r\n\t\t\tlog('Sending message to host page (' + message + ')');\r\n\t\t\ttarget.postMessage( msgID + message, targetOrigin);\r\n\t\t}\r\n\r\n\t\tsetTargetOrigin();\r\n\t\tsendToParent();\r\n\t}\r\n\r\n\tfunction receiver(event) {\r\n\t\tfunction isMessageForUs(){\r\n\t\t\treturn msgID === (''+event.data).substr(0,msgIdLen); //''+ Protects against non-string messages\r\n\t\t}\r\n\r\n\t\tfunction initFromParent(){\r\n\t\t\tinitMsg = event.data;\r\n\t\t\ttarget  = event.source;\r\n\r\n\t\t\tinit();\r\n\t\t\tfirstRun = false;\r\n\t\t\tsetTimeout(function(){ initLock = false;},eventCancelTimer);\r\n\t\t}\r\n\r\n\t\tfunction resetFromParent(){\r\n\t\t\tif (!initLock){\r\n\t\t\t\tlog('Page size reset by host page');\r\n\t\t\t\ttriggerReset('resetPage');\r\n\t\t\t} else {\r\n\t\t\t\tlog('Page reset ignored by init');\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tfunction resizeFromParent(){\r\n\t\t\tsendSize('resizeParent','Parent window resized');\r\n\t\t}\r\n\r\n\t\tfunction getMessageType(){\r\n\t\t\treturn event.data.split(']')[1];\r\n\t\t}\r\n\r\n\t\tfunction isMiddleTier(){\r\n\t\t\treturn ('iFrameResize' in window);\r\n\t\t}\r\n\r\n\t\tfunction isInitMsg(){\r\n\t\t\t//test if this message is from a child below us. This is an ugly test, however, updating\r\n\t\t\t//the message format would break backwards compatibity.\r\n\t\t\treturn event.data.split(':')[2] in {'true':1,'false':1};\r\n\t\t}\r\n\r\n\t\tif (isMessageForUs()){\r\n\t\t\tif (firstRun === false) {\r\n\t\t\t\tif ('reset' === getMessageType()){\r\n\t\t\t\t\tresetFromParent();\r\n\t\t\t\t} else if ('resize' === getMessageType()){\r\n\t\t\t\t\tresizeFromParent();\r\n\t\t\t\t} else if (event.data !== initMsg && !isMiddleTier()){\r\n\t\t\t\t\twarn('Unexpected message ('+event.data+')');\r\n\t\t\t\t}\r\n\t\t\t} else if (isInitMsg()) {\r\n\t\t\t\tinitFromParent();\r\n\t\t\t} else {\r\n\t\t\t\twarn('Received message of type ('+getMessageType()+') before initialization.');\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\taddEventListener(window, 'message', receiver);\r\n\r\n})();\r\n"]}